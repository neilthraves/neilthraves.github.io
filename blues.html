<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Blues Call & Response Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- PWA Manifest (inline via data URL) -->
<link rel="manifest" href='data:application/json,{
  "name":"Blues Call & Response",
  "short_name":"Blues C&R",
  "start_url":".",
  "display":"standalone",
  "background_color":"#111111",
  "theme_color":"#111111",
  "icons":[]
}'>

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #111;
    color: #eee;
    padding: 16px;
    max-width: 420px;
    margin: auto;
  }

  h1 {
    font-size: 1.2rem;
    margin-bottom: 12px;
    text-align: center;
  }

  select, button {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    font-size: 1rem;
    background: #222;
    color: #eee;
    border: 1px solid #444;
    border-radius: 6px;
  }

  .box {
    border: 1px solid #333;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
  }

  .label {
    font-size: 0.8rem;
    color: #aaa;
    margin-bottom: 4px;
  }

  .phrase {
    font-size: 1.1rem;
    letter-spacing: 1px;
  }
</style>
</head>

<body>

<h1>Blues Call & Response</h1>

<select id="root">
  <option value="60">C</option>
  <option value="62">D</option>
  <option value="64">E</option>
  <option value="65">F</option>
  <option value="67">G</option>
  <option value="69">A</option>
  <option value="71">B</option>
</select>

<select id="chord">
  <option value="I">I (Tonic)</option>
  <option value="IV">IV (Subdominant)</option>
  <option value="V">V (Dominant)</option>
</select>

<button id="generate" type="button">Generate Pattern</button>
<button id="playCall" type="button">Play Call</button>
<button id="playResponse" type="button">Play Response</button>
<button id="playBoth" type="button">Play Call + Response</button>

<div class="box">
  <div class="label">CALL (no resolution)</div>
  <div class="phrase" id="callDisplay">—</div>
</div>

<div class="box">
  <div class="label">RESPONSE (resolution)</div>
  <div class="phrase" id="responseDisplay">—</div>
</div>

<script>
/* iOS gesture hardening */
document.addEventListener("touchstart", () => {}, { once: true });

/* Service Worker (inline, offline cache) */
if ("serviceWorker" in navigator) {
  const swCode = `
    const CACHE = "blues-call-response-v1";
    self.addEventListener("install", e => {
      e.waitUntil(
        caches.open(CACHE).then(c =>
          c.addAll(["./"])
        )
      );
    });
    self.addEventListener("fetch", e => {
      e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request))
      );
    });
  `;
  const blob = new Blob([swCode], { type: "text/javascript" });
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL);
}

let audioCtx = null;

/* Interval map */
const intervalMap = {
  "1": 0,
  "2": 2,
  "b3": 3,
  "3": 4,
  "4": 5,
  "b5": 6,
  "5": 7,
  "b7": 10
};

/* Call rules */
const callPool = ["5", "b7", "b3", "2", "4"];
const callEndNotes = ["b3", "2", "b5", "b7"];

/* Response rules by chord */
const responsePool = ["b3", "4", "2", "5"];

const responseTargets = {
  I: ["3", "b7", "1"],
  IV: ["3", "1"],
  V: ["3"]   // dominant pull — strong resolution
};

let callPhrase = [];
let responsePhrase = [];

function randomItem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function generatePhrase() {
  callPhrase = [
    randomItem(callPool),
    randomItem(callPool),
    randomItem(callEndNotes)
  ];

  const chord = document.getElementById("chord").value;
  const resolution = randomItem(responseTargets[chord]);

  responsePhrase = [
    randomItem(responsePool),
    resolution
  ];

  callDisplay.textContent = callPhrase.join(" – ");
  responseDisplay.textContent = responsePhrase.join(" – ");
}

function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") {
    audioCtx.resume();
  }
}

function playIntervals(intervals) {
  if (!intervals.length) return;

  ensureAudio();

  const root = parseInt(rootSelect.value, 10);
  const chord = chordSelect.value;

  let base = root;
  if (chord === "IV") base = root + 5;
  if (chord === "V") base = root + 7;

  let time = audioCtx.currentTime;

  intervals.forEach(interval => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    const midi = base + intervalMap[interval];
    const freq = 440 * Math.pow(2, (midi - 69) / 12);

    osc.type = "sine";
    osc.frequency.value = freq;

    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(0.25, time + 0.04);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.7);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start(time);
    osc.stop(time + 0.8);

    time += 0.9; // doubled duration
  });
}

/* Elements */
const rootSelect = document.getElementById("root");
const chordSelect = document.getElementById("chord");
const callDisplay = document.getElementById("callDisplay");
const responseDisplay = document.getElementById("responseDisplay");

/* Buttons */
generate.onclick = generatePhrase;
playCall.onclick = () => playIntervals(callPhrase);
playResponse.onclick = () => playIntervals(responsePhrase);
playBoth.onclick = () => playIntervals([...callPhrase, ...responsePhrase]);
</script>

</body>
</html>