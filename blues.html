<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Blues Call & Response</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #111;
    color: #eee;
    padding: 16px;
    max-width: 420px;
    margin: auto;
  }

  h1 {
    font-size: 1.1rem;
    text-align: center;
    margin-bottom: 12px;
    font-weight: 500;
    letter-spacing: 1px;
  }

  select, button {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    font-size: 1rem;
    background: #222;
    color: #eee;
    border: 1px solid #444;
    border-radius: 6px;
  }

  .box {
    border: 1px solid #333;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
    background: #151515;
  }

  .label {
    font-size: 0.7rem;
    color: #888;
    margin-bottom: 4px;
    letter-spacing: 1px;
  }

  .phrase {
    font-size: 1.1rem;
    letter-spacing: 1px;
  }
</style>
</head>

<body>

<h1>CALL → RESPONSE</h1>

<select id="root">
  <option value="60">C</option>
  <option value="62">D</option>
  <option value="64">E</option>
  <option value="65">F</option>
  <option value="67">G</option>
  <option value="69">A</option>
  <option value="71">B</option>
</select>

<select id="chord">
  <option value="I">I</option>
  <option value="IV">IV</option>
  <option value="V">V</option>
</select>

<button id="generate" type="button">Generate</button>
<button id="playCall" type="button">Play Call</button>
<button id="playResponse" type="button">Play Response</button>
<button id="playBoth" type="button">Play Both</button>

<div class="box">
  <div class="label">CALL</div>
  <div class="phrase" id="callDisplay">—</div>
</div>

<div class="box">
  <div class="label">RESPONSE</div>
  <div class="phrase" id="responseDisplay">—</div>
</div>

<script>
document.addEventListener("touchstart", () => {}, { once: true });

let audioCtx = null;
let lastCall = null;

/* Interval map */
const intervalMap = {
  "1": 0,
  "2": 2,
  "b3": 3,
  "3": 4,
  "4": 5,
  "b5": 6,
  "5": 7,
  "b7": 10
};

/* ===== REAL BLUES VOCAB ===== */

const CALL_PATTERNS = [
  ["b3", "4", "b3"],
  ["b3", "4", "b3"],
  ["5", "b7", "5"],
  ["b3", "2"],
  ["4", "b3"],
  ["5", "5", "b7"],
  ["b7", "5"],
  ["2", "b3", "4"]
];

const RESPONSE_I = [
  ["b3", "3"], ["b3", "3"],
  ["4", "3"],
  ["b7", "3"],
  ["3"],
  ["b7"]
];

const RESPONSE_IV = [
  ["b3", "3"],
  ["4", "3"],
  ["3"],
  ["1"]
];

const RESPONSE_V = [
  ["4", "3"],
  ["b7", "3"],
  ["3"]
];

function randomItem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function generatePhrase() {
  const chord = chordSelect.value;

  if (lastCall && Math.random() < 0.5) {
    callPhrase = lastCall;
  } else {
    callPhrase = randomItem(CALL_PATTERNS);
    lastCall = callPhrase;
  }

  if (chord === "I") responsePhrase = randomItem(RESPONSE_I);
  if (chord === "IV") responsePhrase = randomItem(RESPONSE_IV);
  if (chord === "V") responsePhrase = randomItem(RESPONSE_V);

  callDisplay.textContent = callPhrase.join(" – ");
  responseDisplay.textContent = responsePhrase.join(" – ");
}

/* ===== AUDIO ===== */

function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") audioCtx.resume();
}

function playWithDrone(intervals) {
  if (!intervals || !intervals.length) return;
  ensureAudio();

  const root = parseInt(rootSelect.value, 10);
  const chord = chordSelect.value;

  let base = root;
  if (chord === "IV") base += 5;
  if (chord === "V") base += 7;

  const now = audioCtx.currentTime;

  /* Drone */
  const droneOsc = audioCtx.createOscillator();
  const droneGain = audioCtx.createGain();
  droneOsc.type = "sine";
  droneOsc.frequency.value = 440 * Math.pow(2, (base - 69) / 12);
  droneGain.gain.value = 0.08;

  droneOsc.connect(droneGain).connect(audioCtx.destination);
  droneOsc.start(now);

  let time = now;

  intervals.forEach(i => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    const midi = base + intervalMap[i];
    const freq = 440 * Math.pow(2, (midi - 69) / 12);

    osc.type = "sine";
    osc.frequency.value = freq;

    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(0.25, time + 0.05);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 1.2);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start(time);
    osc.stop(time + 1.3);

    time += 1.4;
  });

  droneOsc.stop(time + 0.2);
}

/* Elements */
const rootSelect = document.getElementById("root");
const chordSelect = document.getElementById("chord");
const callDisplay = document.getElementById("callDisplay");
const responseDisplay = document.getElementById("responseDisplay");

/* Buttons */
generate.onclick = generatePhrase;
playCall.onclick = () => playWithDrone(callPhrase);
playResponse.onclick = () => playWithDrone(responsePhrase);
playBoth.onclick = () => playWithDrone([...callPhrase, ...responsePhrase]);
</script>

</body>
</html>