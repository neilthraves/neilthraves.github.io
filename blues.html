<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Blues Call & Response Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #111;
    color: #eee;
    padding: 16px;
    max-width: 420px;
    margin: auto;
  }

  h1 {
    font-size: 1.2rem;
    margin-bottom: 12px;
    text-align: center;
  }

  select, button {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    font-size: 1rem;
    background: #222;
    color: #eee;
    border: 1px solid #444;
    border-radius: 6px;
  }

  .box {
    border: 1px solid #333;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
  }

  .label {
    font-size: 0.8rem;
    color: #aaa;
    margin-bottom: 4px;
  }

  .phrase {
    font-size: 1.1rem;
    letter-spacing: 1px;
  }
</style>
</head>

<body>

<h1>Blues Call & Response</h1>

<select id="root">
  <option value="60">C</option>
  <option value="62">D</option>
  <option value="64">E</option>
  <option value="65">F</option>
  <option value="67">G</option>
  <option value="69">A</option>
  <option value="71">B</option>
</select>

<button id="generate" type="button">Generate Pattern</button>
<button id="play" type="button">Play</button>

<div class="box">
  <div class="label">CALL (no resolution)</div>
  <div class="phrase" id="callDisplay">—</div>
</div>

<div class="box">
  <div class="label">RESPONSE (resolution)</div>
  <div class="phrase" id="responseDisplay">—</div>
</div>

<script>
/* iOS Safari gesture hardening */
document.addEventListener("touchstart", () => {}, { once: true });

let audioCtx = null;

const intervalMap = {
  "1": 0,
  "2": 2,
  "b3": 3,
  "3": 4,
  "4": 5,
  "b5": 6,
  "5": 7,
  "b7": 10
};

const callEndNotes = ["b3", "2", "b5", "b7"];
const responseEndNotes = ["3", "b7", "1"];
const callPool = ["5", "b7", "b3", "2", "4"];
const responsePool = ["b3", "4", "2", "5"];

let callPhrase = [];
let responsePhrase = [];

function randomItem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function generatePhrase() {
  callPhrase = [
    randomItem(callPool),
    randomItem(callPool),
    randomItem(callEndNotes)
  ];

  const resolution = randomItem(responseEndNotes);
  responsePhrase = [
    randomItem(responsePool),
    resolution
  ];

  document.getElementById("callDisplay").textContent =
    callPhrase.join(" – ");

  document.getElementById("responseDisplay").textContent =
    responsePhrase.join(" – ");
}

function playPhrase() {
  if (!callPhrase.length) return;

  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  const root = parseInt(
    document.getElementById("root").value,
    10
  );

  const sequence = [...callPhrase, ...responsePhrase];
  let time = audioCtx.currentTime;

  sequence.forEach(interval => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    const midi = root + intervalMap[interval];
    const freq = 440 * Math.pow(2, (midi - 69) / 12);

    osc.type = "sine";
    osc.frequency.value = freq;

    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(0.25, time + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.35);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start(time);
    osc.stop(time + 0.4);

    time += 0.45;
  });
}

document.getElementById("generate").addEventListener("click", generatePhrase);
document.getElementById("play").addEventListener("click", playPhrase);
</script>

</body>
</html>